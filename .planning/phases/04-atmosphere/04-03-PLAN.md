---
phase: 04-atmosphere
plan: 03
type: execute
wave: 2
depends_on: ["04-02"]
files_modified:
  - scenes/interior/interior_scene.tscn
  - scenes/interior/interior_scene.gd
autonomous: false

must_haves:
  truths:
    - "Vignette effect visible on screen edges with warm tint"
    - "Point lights cast visible character shadows on environment"
    - "Both blob shadow and point light shadow are visible (dual shadow system)"
  artifacts:
    - path: "scenes/interior/interior_scene.tscn"
      provides: "PostProcessing CanvasLayer with vignette, shadow-enabled OmniLight3D"
      contains: "shadow_enabled = true"
    - path: "scenes/interior/interior_scene.gd"
      provides: "Optional vignette setup code if needed"
  key_links:
    - from: "ColorRect"
      to: "shaders/vignette.gdshader"
      via: "ShaderMaterial assignment"
      pattern: "vignette.gdshader"
    - from: "OmniLight3D"
      to: "PlayerCharacter"
      via: "shadow casting"
      pattern: "shadow_enabled = true"
---

<objective>
Integrate vignette shader into scene and enable point light shadows for directional depth.

Purpose: Complete the atmosphere phase by wiring the vignette shader to the scene and enabling shadows on OmniLight3D nodes. The dual shadow system (blob + point light) provides both grounding and directional depth.

Output: Fully atmospheric interior scene with vignette overlay and point light character shadows.
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-atmosphere/04-CONTEXT.md
@.planning/phases/04-atmosphere/04-RESEARCH.md
@.planning/phases/04-atmosphere/04-02-SUMMARY.md
@scenes/interior/interior_scene.tscn
@scenes/interior/interior_scene.gd
@shaders/vignette.gdshader
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PostProcessing CanvasLayer with vignette ColorRect</name>
  <files>scenes/interior/interior_scene.tscn</files>
  <action>
Add a CanvasLayer and ColorRect to interior_scene.tscn for vignette post-processing.

Add these resources at the top of the file (after existing ext_resource entries):
```
[ext_resource type="Shader" uid="uid://..." path="res://shaders/vignette.gdshader" id="XX_vignette"]
```
(Replace XX with next available id number, Godot will auto-assign uid)

Add a sub_resource for the ShaderMaterial:
```
[sub_resource type="ShaderMaterial" id="ShaderMaterial_vignette"]
shader = ExtResource("XX_vignette")
shader_parameter/vignette_intensity = 0.4
shader_parameter/vignette_opacity = 0.3
shader_parameter/vignette_color = Color(0.15, 0.1, 0.05, 1)
shader_parameter/edge_blur_strength = 0.3
shader_parameter/edge_blur_size = 1.5
```

Add nodes after the CameraRig node:
```
[node name="PostProcessing" type="CanvasLayer" parent="."]
layer = 0

[node name="Vignette" type="ColorRect" parent="PostProcessing"]
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
mouse_filter = 2
material = SubResource("ShaderMaterial_vignette")
```

Note: mouse_filter = 2 is MOUSE_FILTER_IGNORE so vignette doesn't block input.
  </action>
  <verify>
Open scene in Godot. Scene tree should show:
- PostProcessing (CanvasLayer)
  - Vignette (ColorRect)

ColorRect should fill entire viewport. Select Vignette node and confirm Material shows ShaderMaterial with vignette shader assigned.
  </verify>
  <done>CanvasLayer with vignette ColorRect added, shader parameters configured per CONTEXT.md (subtle opacity, warm tint).</done>
</task>

<task type="auto">
  <name>Task 2: Enable shadows on OmniLight3D lamp nodes</name>
  <files>scenes/interior/interior_scene.tscn</files>
  <action>
Modify the existing OmniLight3D nodes to enable soft shadows per CONTEXT.md decisions.

For TableLamp node (under Lighting/Lamps), add:
```
shadow_enabled = true
shadow_blur = 1.5
shadow_bias = 0.02
shadow_normal_bias = 1.0
```

For FloorLamp node (under Lighting/Lamps), add the same shadow properties:
```
shadow_enabled = true
shadow_blur = 1.5
shadow_bias = 0.02
shadow_normal_bias = 1.0
```

For Fireplace node (under Lighting), add:
```
shadow_enabled = true
shadow_blur = 2.0
shadow_bias = 0.02
shadow_normal_bias = 1.0
```
(Fireplace gets slightly softer shadows since it's a larger diffuse light source)

Do NOT modify the DirectionalLight3D (WindowLight) - it already has shadow_enabled = true.

The character's Sprite3D (billboard) will cast shadows from these point lights, creating directional depth alongside the existing blob shadow (Decal) for grounding.
  </action>
  <verify>
Open scene in Godot. Select TableLamp, FloorLamp, and Fireplace nodes.
Inspector should show Shadow section with:
- Enabled: checked
- Blur: 1.5-2.0
- Bias: 0.02

Run scene and position camera to see character. Character should cast multiple shadows from different light sources.
  </verify>
  <done>Point lights cast soft shadows (30-40% visible via shadow_blur softness), complementing blob shadow for dual shadow system.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete HD-2D atmosphere effects:
1. Bloom configured for emissive-only glow (Plan 01)
2. Volumetric fog with subtle light shafts (Plan 01)
3. Rectangular vignette with warm tint and edge blur (Plan 02 + this plan)
4. Point light shadows from lamps (this plan)
  </what-built>
  <how-to-verify>
Run the scene (F5 in Godot) and evaluate:

1. **Vignette:** Look at screen edges
   - Should see subtle darkening with warm brown tint
   - Effect should be barely noticeable (not tunnel vision)
   - Edges should have slight softness/blur

2. **Volumetric fog:** Look at lamp areas
   - Should see faint light rays/dust-in-air effect
   - Scene should NOT look foggy or washed out

3. **Point light shadows:** Move character near lamps
   - Character should cast shadows from TableLamp and FloorLamp
   - Shadows should be soft (not sharp edges)
   - BOTH blob shadow (on floor directly under character) AND directional shadows should be visible

4. **Overall atmosphere:**
   - Scene should feel dreamy/cozy without losing pixel art clarity
   - Navigate around to check from multiple angles
  </how-to-verify>
  <resume-signal>Type "approved" if atmosphere looks good, or describe what needs adjustment (e.g., "vignette too strong", "no shadows visible", "fog too dense")</resume-signal>
</task>

</tasks>

<verification>
1. PostProcessing CanvasLayer exists in scene tree
2. Vignette ColorRect has ShaderMaterial with vignette.gdshader
3. TableLamp, FloorLamp, Fireplace have shadow_enabled = true
4. Character casts shadows from point lights
5. Blob shadow (Decal) still visible under character
6. Vignette effect visible but subtle
7. Overall scene has dreamy HD-2D atmosphere
</verification>

<success_criteria>
- REND-02: Bloom creates soft light bleeding on emissive areas
- REND-03: Vignette darkens and blurs screen edges
- REND-04: Volumetric fog adds visible atmospheric haze
- SPRT-03: Point lights cast visible character shadows
- All four Phase 4 success criteria met
</success_criteria>

<output>
After completion, create `.planning/phases/04-atmosphere/04-03-SUMMARY.md`
</output>

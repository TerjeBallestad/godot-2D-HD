---
phase: 04-atmosphere
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - shaders/vignette.gdshader
autonomous: true

must_haves:
  truths:
    - "Vignette shader file exists and compiles without errors"
  artifacts:
    - path: "shaders/vignette.gdshader"
      provides: "Rectangular vignette with edge blur and warm tint"
      min_lines: 20
  key_links:
    - from: "shaders/vignette.gdshader"
      to: "hint_screen_texture"
      via: "screen texture sampling for post-processing"
      pattern: "hint_screen_texture"
---

<objective>
Create the vignette shader file for rectangular edge darkening with subtle blur and warm brown/sepia tint.

Purpose: Vignette frames the scene cinematically, guiding the eye to center. The rectangular shape follows screen edges (not circular/oval). Slight edge blur complements the Phase 5 tilt-shift effect.

Output: A canvas_item shader ready for use with ColorRect post-processing.
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-atmosphere/04-CONTEXT.md
@.planning/phases/04-atmosphere/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shaders directory</name>
  <files>shaders/</files>
  <action>
Create the shaders/ directory at project root if it doesn't exist:

```bash
mkdir -p shaders
```

This directory will hold post-processing shaders for the HD-2D effects.
  </action>
  <verify>Directory exists: `ls -la shaders/`</verify>
  <done>shaders/ directory exists at project root.</done>
</task>

<task type="auto">
  <name>Task 2: Create vignette shader with rectangular falloff</name>
  <files>shaders/vignette.gdshader</files>
  <action>
Create shaders/vignette.gdshader with the following content:

```gdshader
shader_type canvas_item;

// Vignette effect for HD-2D atmosphere
// Rectangular shape following screen edges with warm tint and subtle edge blur

uniform sampler2D screen_texture : hint_screen_texture, repeat_disable, filter_linear;

// Vignette parameters
uniform float vignette_intensity : hint_range(0.0, 1.0) = 0.4;
uniform float vignette_opacity : hint_range(0.0, 1.0) = 0.3;
uniform vec4 vignette_color : source_color = vec4(0.15, 0.1, 0.05, 1.0);  // Warm brown/sepia

// Edge blur parameters (complements Phase 5 tilt-shift)
uniform float edge_blur_strength : hint_range(0.0, 1.0) = 0.3;
uniform float edge_blur_size : hint_range(0.0, 4.0) = 1.5;

void fragment() {
    vec4 screen_color = texture(screen_texture, SCREEN_UV);

    // Rectangular vignette calculation
    // Uses UV multiplication trick: corners approach 0, center approaches max
    vec2 uv = UV;
    uv *= 1.0 - uv.yx;  // uv.x * (1-uv.y) and uv.y * (1-uv.x)

    // Calculate vignette factor (higher at center, lower at edges)
    float vig = uv.x * uv.y * 15.0;  // Scale factor for nice falloff
    vig = pow(vig, vignette_intensity);
    vig = clamp(vig, 0.0, 1.0);

    // Edge factor (inverse of vignette - higher at edges)
    float edge_factor = 1.0 - vig;

    // Apply subtle edge blur using LOD sampling
    // Higher LOD = more blur, scaled by edge_factor for gradual transition
    float blur_lod = edge_factor * edge_blur_strength * edge_blur_size;
    vec4 blurred_color = textureLod(screen_texture, SCREEN_UV, blur_lod);

    // Blend between sharp and blurred based on edge factor
    vec3 color_with_blur = mix(screen_color.rgb, blurred_color.rgb, edge_factor * edge_blur_strength);

    // Apply vignette color tint at edges
    vec3 tinted_color = mix(color_with_blur, vignette_color.rgb, edge_factor * vignette_opacity);

    // Final output
    COLOR.rgb = tinted_color;
    COLOR.a = 1.0;
}
```

Key design decisions per CONTEXT.md:
- Rectangular shape via UV multiplication (not radial distance from center)
- Warm brown/sepia default color (0.15, 0.1, 0.05)
- Very subtle opacity default (0.3) - barely noticeable
- Edge blur using LOD sampling for performance
- All parameters exposed as uniforms for tuning in editor
  </action>
  <verify>
Verify shader file exists and has correct structure:
```bash
cat shaders/vignette.gdshader | head -20
```
Shader should start with `shader_type canvas_item;` and contain `hint_screen_texture`.
  </verify>
  <done>Vignette shader created with rectangular falloff, warm tint, and edge blur ready for ColorRect integration.</done>
</task>

</tasks>

<verification>
1. File exists at shaders/vignette.gdshader
2. Shader type is canvas_item (correct for 2D post-processing overlay)
3. Uses hint_screen_texture for screen sampling
4. Has uniform parameters for vignette_intensity, vignette_opacity, vignette_color, edge_blur_strength
5. Default values match CONTEXT.md decisions (subtle, warm brown)
</verification>

<success_criteria>
- Shader file compiles without errors when imported by Godot
- Rectangular vignette calculation (not circular)
- Warm brown/sepia tint configurable
- Edge blur effect using LOD sampling
- REND-03 (vignette) shader component complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-atmosphere/04-02-SUMMARY.md`
</output>

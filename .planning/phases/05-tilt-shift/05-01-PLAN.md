---
phase: 05-tilt-shift
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shaders/tilt_shift.gdshader
  - scenes/interior/tilt_shift_controller.gd
  - scenes/interior/interior_scene.tscn
autonomous: false

must_haves:
  truths:
    - "Objects far from the character are visibly blurred"
    - "Objects near the character (focal plane) remain sharp"
    - "Focal point follows the character as they move through the scene"
    - "The combined effect creates the characteristic miniature/diorama look"
    - "Toggle exists to disable effect for A/B comparison"
  artifacts:
    - path: "shaders/tilt_shift.gdshader"
      provides: "Depth-based tilt-shift blur shader"
      contains: "hint_depth_texture"
    - path: "scenes/interior/tilt_shift_controller.gd"
      provides: "Focal tracking controller"
      contains: "focal_point"
    - path: "scenes/interior/interior_scene.tscn"
      provides: "TiltShiftQuad integrated into scene"
      contains: "TiltShiftQuad"
  key_links:
    - from: "scenes/interior/tilt_shift_controller.gd"
      to: "player_character"
      via: "player reference for focal tracking"
      pattern: "player\\.global_position"
    - from: "scenes/interior/tilt_shift_controller.gd"
      to: "shaders/tilt_shift.gdshader"
      via: "set_shader_parameter"
      pattern: "set_shader_parameter.*focal_point"
---

<objective>
Implement depth-based tilt-shift blur effect that creates the signature HD-2D miniature/diorama aesthetic

Purpose: This is the final visual layer of the HD-2D prototype - the depth-based blur that makes scenes look like miniature dioramas. This completes the visual evaluation and enables the go/no-go decision.

Output: Tilt-shift shader with focal tracking, integrated into scene as fullscreen quad
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-tilt-shift/05-CONTEXT.md
@.planning/phases/05-tilt-shift/05-RESEARCH.md
@scenes/interior/camera_rig.gd
@scenes/character/player_character.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tilt-shift depth shader</name>
  <files>shaders/tilt_shift.gdshader</files>
  <action>
Create spatial shader with these characteristics (from CONTEXT.md decisions):

**Shader setup:**
```glsl
shader_type spatial;
render_mode unshaded, fog_disabled, depth_draw_never, depth_test_disabled;
```

**Uniforms:**
- `screen_texture : source_color, hint_screen_texture, filter_linear_mipmap` - for mipmap blur
- `depth_texture : hint_depth_texture` - for depth sampling
- `focal_point : vec3` - world position to focus on (updated by controller)
- `focus_distance : float = 1.5` (hint_range 0.5-5.0) - wide focus zone
- `blur_max : float = 2.0` (hint_range 0.0-4.0) - subtle blur cap
- `blur_transition : float = 2.0` (hint_range 0.5-5.0) - smooth gradient
- `enabled : bool = true` - toggle for A/B comparison

**Vertex function:**
```glsl
void vertex() {
    POSITION = vec4(VERTEX.xy, 1.0, 1.0);
}
```

**Fragment function:**
1. Early return with unblurred screen if `!enabled`
2. Sample depth and reconstruct world position using INV_PROJECTION_MATRIX and INV_VIEW_MATRIX
3. Calculate spherical distance from world position to focal_point
4. Compute blur_factor using smoothstep for smooth ease falloff
5. Reduce blur at screen edges using UV-based falloff (smoothstep 0.0-0.1)
6. Sample screen_texture with textureLod using blur_amount

Reference the exact patterns from RESEARCH.md Code Examples section.
  </action>
  <verify>File exists at shaders/tilt_shift.gdshader, contains shader_type spatial, hint_depth_texture, focal_point uniform, smoothstep, textureLod</verify>
  <done>Tilt-shift shader file created with depth-based blur, focal point uniform, and toggle</done>
</task>

<task type="auto">
  <name>Task 2: Add TiltShiftQuad and focal tracking controller</name>
  <files>scenes/interior/tilt_shift_controller.gd, scenes/interior/interior_scene.tscn</files>
  <action>
**Create controller script** `scenes/interior/tilt_shift_controller.gd`:

```gdscript
extends MeshInstance3D
## Tilt-shift focal tracking controller.
## Updates shader focal_point uniform to follow player with smooth lag.

@export var player_path: NodePath
@export var focal_smoothing: float = 5.0  # Higher = faster follow
@export var focal_height_offset: float = 0.5  # Mid-body anchor

var player: Node3D
var current_focal: Vector3 = Vector3.ZERO
var shader_material: ShaderMaterial

func _ready() -> void:
    # Get player reference
    player = get_node_or_null(player_path)
    if not player:
        push_warning("TiltShiftController: No player found at path")
        return

    # Get shader material (surface 0 of QuadMesh)
    shader_material = mesh.surface_get_material(0) as ShaderMaterial
    if not shader_material:
        push_error("TiltShiftController: No ShaderMaterial found")
        return

    # Initialize focal point to player position
    current_focal = player.global_position + Vector3(0, focal_height_offset, 0)
    shader_material.set_shader_parameter("focal_point", current_focal)

func _process(delta: float) -> void:
    if not player or not shader_material:
        return

    # Target: player position + height offset for mid-body anchor
    var target_focal = player.global_position + Vector3(0, focal_height_offset, 0)

    # Exponential smoothing for slight lag (from RESEARCH.md)
    current_focal = current_focal.lerp(target_focal, 1.0 - exp(-focal_smoothing * delta))

    shader_material.set_shader_parameter("focal_point", current_focal)

func toggle_effect() -> void:
    if shader_material:
        var current = shader_material.get_shader_parameter("enabled")
        shader_material.set_shader_parameter("enabled", !current)
```

**Modify interior_scene.tscn** to add TiltShiftQuad:

Add as child of Camera3D node (inside CameraRig > InnerGimbal > Camera3D):

```
TiltShiftQuad (MeshInstance3D)
  - script: tilt_shift_controller.gd
  - player_path: "../../../../PlayerCharacter" (relative from TiltShiftQuad to PlayerCharacter)
  - mesh: QuadMesh
    - size: Vector2(2, 2)
    - flip_faces: true
  - transform.origin: Vector3(0, 0, -0.1)
  - extra_cull_margin: 16384
  - material_override: ShaderMaterial
    - shader: tilt_shift.gdshader
```

Use Godot scene editing (read existing TSCN, add node). Reference how PostProcessing CanvasLayer was added in Phase 04.

**Add input handling for toggle (T key)** in camera_rig.gd:
- Add KEY_T case in _unhandled_input
- Get TiltShiftQuad node and call toggle_effect()
  </action>
  <verify>Run scene in Godot editor. Blur effect visible. Move character - focal point follows. Press T - effect toggles.</verify>
  <done>TiltShiftQuad added to Camera3D hierarchy, controller tracks player with smoothed focal point, T toggles effect</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete depth-based tilt-shift effect with focal tracking and toggle</what-built>
  <how-to-verify>
This is the go/no-go evaluation moment for the HD-2D prototype:

1. Run the project in Godot (F5 or Play button)
2. Observe the scene - objects far from the character should be subtly blurred
3. Click to move the character around the scene
4. Verify the focal point follows smoothly (slight lag, not snappy)
5. Press T to toggle the effect off and on for A/B comparison
6. Walk through the scene and judge by gut feel:
   - Does it create a "miniature diorama" effect?
   - Is the blur subtle (enhancement, not distraction)?
   - Does the combination of all effects (bloom, vignette, fog, tilt-shift) achieve HD-2D?

Expected:
- Near the character: sharp/in-focus furniture and floor
- Far from character: softly blurred, still recognizable
- Smooth transition between sharp and blurred areas
- Toggle clearly shows the difference
  </how-to-verify>
  <resume-signal>Type "approved" for go decision, or describe issues/adjustments needed</resume-signal>
</task>

</tasks>

<verification>
- [ ] shaders/tilt_shift.gdshader exists with depth-based blur implementation
- [ ] Shader has enabled uniform for A/B toggle
- [ ] TiltShiftQuad node exists as Camera3D child
- [ ] Controller script tracks player with smoothed focal point
- [ ] T key toggles effect on/off
- [ ] Effect visible in running scene - far objects blur, near objects sharp
- [ ] Miniature/diorama aesthetic achieved (user visual approval)
</verification>

<success_criteria>
Phase 5 complete when:
1. Tilt-shift effect renders correctly with depth-based blur
2. Focal point tracks player position with smooth lag
3. Toggle allows A/B comparison (T key)
4. User approves visual quality (go/no-go decision)
5. Combined HD-2D aesthetic (bloom + vignette + fog + tilt-shift) feels right
</success_criteria>

<output>
After completion, create `.planning/phases/05-tilt-shift/05-01-SUMMARY.md`
</output>

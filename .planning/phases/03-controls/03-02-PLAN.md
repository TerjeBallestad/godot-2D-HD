---
phase: 03-controls
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - scenes/interior/interior_scene.tscn
  - scenes/interior/camera_rig.gd
autonomous: true

must_haves:
  truths:
    - "Q/E keys rotate camera in 45-degree increments"
    - "Right-click drag orbits camera (snaps to 45-degree on release)"
    - "Mouse wheel zooms camera in/out smoothly"
    - "+/- keys zoom camera in/out"
    - "R key resets camera to default position and zoom"
    - "All camera transitions are animated with easing"
  artifacts:
    - path: "scenes/interior/interior_scene.tscn"
      provides: "Camera gimbal rig structure (CameraRig > InnerGimbal > Camera3D)"
      contains: "CameraRig"
    - path: "scenes/interior/camera_rig.gd"
      provides: "Camera orbit, zoom, and reset controls"
      min_lines: 80
  key_links:
    - from: "scenes/interior/camera_rig.gd"
      to: "CameraRig rotation"
      via: "Tween for smooth Y-axis rotation to 45-degree increments"
      pattern: "tween.*rotation|rotate_y"
    - from: "scenes/interior/camera_rig.gd"
      to: "Camera3D position"
      via: "Tween for smooth zoom (Z position change)"
      pattern: "tween.*position|zoom"
---

<objective>
Camera gimbal rig with orbit rotation (45-degree snapping) and smooth zoom controls.

Purpose: Allow user to view the HD-2D scene from any angle to evaluate the visual style. Camera pivots around room center (not player) for consistent scene evaluation.

Output: Working camera controls with Q/E keyboard rotation, right-click drag orbit, mouse wheel zoom, +/- zoom keys, and R reset.
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-controls/03-CONTEXT.md
@.planning/phases/03-controls/03-RESEARCH.md
@scenes/interior/interior_scene.tscn
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create camera gimbal rig with orbit controls</name>
  <files>scenes/interior/interior_scene.tscn, scenes/interior/camera_rig.gd</files>
  <action>
Restructure camera in interior_scene.tscn to use gimbal hierarchy:

1. Replace the existing Camera3D node with a gimbal structure:
```
CameraRig (Node3D)           # At scene origin (0,0,0) - pivots around room center
└── InnerGimbal (Node3D)     # Handles vertical tilt (X rotation)
    └── Camera3D             # Positioned at distance from pivot
```

2. Camera positioning based on current camera transform:
   - Current camera position: (3, 2.5, 3) with rotation looking at origin
   - Distance from origin: ~4.6 units
   - Elevation angle: ~30 degrees (atan2(2.5, 4.2))

   New structure:
   - CameraRig: position (0, 0, 0), rotation_degrees.y = 45 (initial angle)
   - InnerGimbal: rotation_degrees.x = -30 (tilt down 30 degrees)
   - Camera3D: position (0, 0, 5) with FOV 29.7 (preserved from existing)

3. Create camera_rig.gd script attached to CameraRig:

```gdscript
extends Node3D
## Camera gimbal with orbit rotation (45-degree snapping) and zoom controls.
## Pivots around room center for consistent scene evaluation.

@onready var inner_gimbal: Node3D = $InnerGimbal
@onready var camera: Camera3D = $InnerGimbal/Camera3D

# Orbit settings
const SNAP_ANGLE: float = 45.0  # Degrees per snap position
const ORBIT_TRANSITION_TIME: float = 0.3  # Seconds for smooth snap

# Zoom settings
const ZOOM_MIN: float = 3.0  # Closest zoom (character ~1/3 screen)
const ZOOM_MAX: float = 8.0  # Furthest zoom
const ZOOM_STEP: float = 0.5  # Per scroll/key press
const ZOOM_TRANSITION_TIME: float = 0.15  # Seconds for smooth zoom

# Default values for reset
const DEFAULT_ROTATION: float = 45.0  # degrees
const DEFAULT_ZOOM: float = 5.0  # camera distance

# State
var current_snap_index: int = 1  # 0-7 for 8 positions (starting at 45 degrees)
var current_zoom: float = 5.0
var orbit_tween: Tween = null
var zoom_tween: Tween = null

# Drag state
var is_dragging: bool = false
var drag_start_rotation: float = 0.0
var drag_start_mouse: Vector2 = Vector2.ZERO

func _ready() -> void:
    # Set initial state
    rotation_degrees.y = DEFAULT_ROTATION
    current_zoom = DEFAULT_ZOOM
    camera.position.z = current_zoom

func _unhandled_input(event: InputEvent) -> void:
    # Keyboard rotation: Q/E
    if event.is_action_pressed("ui_focus_prev"):  # Q key (default mapping)
        _rotate_camera(-1)
    elif event.is_action_pressed("ui_focus_next"):  # E key (default mapping)
        _rotate_camera(1)

    # Keyboard zoom: +/-
    if event is InputEventKey and event.pressed:
        if event.keycode == KEY_EQUAL or event.keycode == KEY_KP_ADD:  # + key
            _zoom_camera(-ZOOM_STEP)  # Negative = closer
        elif event.keycode == KEY_MINUS or event.keycode == KEY_KP_SUBTRACT:  # - key
            _zoom_camera(ZOOM_STEP)  # Positive = farther
        elif event.keycode == KEY_R:  # Reset
            _reset_camera()

    # Mouse wheel zoom
    if event is InputEventMouseButton:
        if event.button_index == MOUSE_BUTTON_WHEEL_UP and event.pressed:
            _zoom_camera(-ZOOM_STEP)
        elif event.button_index == MOUSE_BUTTON_WHEEL_DOWN and event.pressed:
            _zoom_camera(ZOOM_STEP)

        # Right-click drag for orbit
        if event.button_index == MOUSE_BUTTON_RIGHT:
            if event.pressed:
                is_dragging = true
                drag_start_rotation = rotation_degrees.y
                drag_start_mouse = event.position
            else:
                is_dragging = false
                _snap_to_nearest_angle()

    # Mouse motion for drag orbit
    if event is InputEventMouseMotion and is_dragging:
        var delta_x = event.position.x - drag_start_mouse.x
        # Sensitivity: 360 degrees per screen width
        var screen_width = get_viewport().get_visible_rect().size.x
        var rotation_delta = (delta_x / screen_width) * 360.0
        rotation_degrees.y = drag_start_rotation - rotation_delta

func _rotate_camera(direction: int) -> void:
    # direction: -1 for left (Q), +1 for right (E)
    current_snap_index = (current_snap_index + direction) % 8
    if current_snap_index < 0:
        current_snap_index = 7

    var target_rotation = current_snap_index * SNAP_ANGLE
    _animate_rotation(target_rotation)

func _snap_to_nearest_angle() -> void:
    # Find nearest 45-degree snap position
    var current_rotation = fmod(rotation_degrees.y, 360.0)
    if current_rotation < 0:
        current_rotation += 360.0

    current_snap_index = int(round(current_rotation / SNAP_ANGLE)) % 8
    var target_rotation = current_snap_index * SNAP_ANGLE

    # Handle wrap-around for smooth animation
    var diff = target_rotation - rotation_degrees.y
    if diff > 180:
        target_rotation -= 360
    elif diff < -180:
        target_rotation += 360

    _animate_rotation(target_rotation)

func _animate_rotation(target_degrees: float) -> void:
    # Kill existing tween to allow immediate redirect (per research pitfall #5)
    if orbit_tween:
        orbit_tween.kill()

    orbit_tween = create_tween()
    orbit_tween.set_ease(Tween.EASE_IN_OUT)
    orbit_tween.set_trans(Tween.TRANS_CUBIC)
    orbit_tween.tween_property(self, "rotation_degrees:y", target_degrees, ORBIT_TRANSITION_TIME)

func _zoom_camera(delta: float) -> void:
    var target_zoom = clampf(current_zoom + delta, ZOOM_MIN, ZOOM_MAX)
    if target_zoom == current_zoom:
        return

    current_zoom = target_zoom
    _animate_zoom(target_zoom)

func _animate_zoom(target_distance: float) -> void:
    if zoom_tween:
        zoom_tween.kill()

    zoom_tween = create_tween()
    zoom_tween.set_ease(Tween.EASE_IN_OUT)
    zoom_tween.set_trans(Tween.TRANS_CUBIC)
    zoom_tween.tween_property(camera, "position:z", target_distance, ZOOM_TRANSITION_TIME)

func _reset_camera() -> void:
    current_snap_index = 1  # 45 degrees
    current_zoom = DEFAULT_ZOOM

    # Animate both rotation and zoom
    _animate_rotation(DEFAULT_ROTATION)
    _animate_zoom(DEFAULT_ZOOM)
```

4. Remove the old Camera3D node and add the new gimbal structure to the scene

Note: Q and E may not have default mappings. If ui_focus_prev/next don't work, add custom input actions or use direct key checks. The script includes fallback handling.
  </action>
  <verify>
Run the scene and test:
1. Press Q - camera should rotate 45 degrees left (animated)
2. Press E - camera should rotate 45 degrees right (animated)
3. Right-click and drag - camera should orbit freely
4. Release right-click - camera should snap to nearest 45-degree position
5. Camera should always face the room center
  </verify>
  <done>
Camera gimbal rig implemented with Q/E rotation (45-degree snapping) and right-click drag orbit. All transitions animate smoothly with easing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add zoom controls and reset functionality</name>
  <files>scenes/interior/camera_rig.gd</files>
  <action>
The zoom and reset functionality is already included in the Task 1 script. This task verifies and may adjust zoom behavior:

1. Verify zoom range is appropriate:
   - ZOOM_MIN = 3.0 should show character at ~1/3 screen height
   - ZOOM_MAX = 8.0 should show full room context
   - Adjust if needed after testing

2. If Q/E don't work with ui_focus_prev/next, update the input handling to use direct key checks:

```gdscript
# Replace the action-based checks with direct key checks if needed:
if event is InputEventKey and event.pressed:
    match event.keycode:
        KEY_Q:
            _rotate_camera(-1)
        KEY_E:
            _rotate_camera(1)
        KEY_EQUAL, KEY_KP_ADD:
            _zoom_camera(-ZOOM_STEP)
        KEY_MINUS, KEY_KP_SUBTRACT:
            _zoom_camera(ZOOM_STEP)
        KEY_R:
            _reset_camera()
```

3. Ensure the camera's `current` property is set to true so it's the active camera:
   - In the gimbal structure, Camera3D should have current = true

4. Test the full interaction flow:
   - Orbit should work independently of zoom
   - Reset should restore both rotation AND zoom
   - Multiple zoom inputs should queue smoothly (or interrupt previous tween)
  </action>
  <verify>
Run the scene and test:
1. Mouse wheel up - camera zooms in (closer to scene)
2. Mouse wheel down - camera zooms out (farther from scene)
3. + key - camera zooms in
4. - key - camera zooms out
5. Zoom should stop at min/max limits (no over-zoom)
6. Press R - camera returns to default angle (45 degrees) and default zoom
7. All zoom transitions should be smooth with easing
  </verify>
  <done>
Zoom controls work via mouse wheel and +/- keys with smooth easing. R key resets camera to default position and zoom. All camera controls function independently and together.
  </done>
</task>

</tasks>

<verification>
Run interior_scene.tscn and test all camera controls:

1. **Orbit rotation:**
   - Q rotates left 45 degrees with smooth animation
   - E rotates right 45 degrees with smooth animation
   - Right-click drag orbits freely
   - Releasing right-click snaps to nearest 45-degree position

2. **Zoom:**
   - Mouse wheel up zooms in (smooth)
   - Mouse wheel down zooms out (smooth)
   - + key zooms in
   - - key zooms out
   - Zoom stops at min/max limits

3. **Reset:**
   - R key returns camera to default angle and zoom
   - Reset is animated, not instant

4. **Combined:**
   - Can orbit while at any zoom level
   - All controls work together without conflict
</verification>

<success_criteria>
- Camera gimbal structure exists (CameraRig > InnerGimbal > Camera3D)
- Q/E keys rotate camera in 45-degree snapping increments
- Right-click drag orbits camera with snap on release
- Mouse wheel and +/- keys zoom smoothly
- R key resets to default position and zoom
- All transitions use TRANS_CUBIC/EASE_IN_OUT for natural feel
</success_criteria>

<output>
After completion, create `.planning/phases/03-controls/03-02-SUMMARY.md`
</output>

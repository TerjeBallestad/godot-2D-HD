---
phase: 02-character
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scenes/character/player_character.tscn
  - scenes/character/player_character.gd
  - scenes/interior/interior_scene.tscn
  - assets/textures/shadow_blob.png
autonomous: false

must_haves:
  truths:
    - "Player character sprite is visible in the 3D scene"
    - "Sprite billboards horizontally to face camera (Y-axis only, stays upright)"
    - "Sprite displays with crisp nearest-neighbor filtering (no blur)"
    - "Sprite feet touch the floor (origin at bottom)"
    - "Blob shadow appears beneath character on the floor"
  artifacts:
    - path: "scenes/character/player_character.tscn"
      provides: "PlayerCharacter scene with Sprite3D, blob shadow, collision"
      contains: "Sprite3D"
    - path: "scenes/character/player_character.gd"
      provides: "Minimal character controller script"
      min_lines: 5
    - path: "scenes/interior/interior_scene.tscn"
      provides: "Interior scene with PlayerCharacter instance"
      contains: "player_character.tscn"
  key_links:
    - from: "scenes/interior/interior_scene.tscn"
      to: "scenes/character/player_character.tscn"
      via: "scene instance"
      pattern: "player_character\\.tscn"
    - from: "scenes/character/player_character.tscn"
      to: "Sprite3D"
      via: "billboard configuration"
      pattern: "billboard.*BILLBOARD_FIXED_Y|billboard = 2"
---

<objective>
Create a pixel-art billboard player character that stands in the 3D interior scene with proper visual integration.

Purpose: Establish the Sprite3D character rendering pattern for HD-2D style (2D characters in 3D environments). This is the first test of mixing pixel art sprites with 3D geometry.

Output: PlayerCharacter scene with Y-axis billboarding Sprite3D, blob shadow via Decal, and collision shape ready for Controls phase.
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-character/02-CONTEXT.md
@.planning/phases/02-character/02-RESEARCH.md
@scenes/interior/interior_scene.tscn
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PlayerCharacter scene with Sprite3D and blob shadow</name>
  <files>
    scenes/character/player_character.tscn
    scenes/character/player_character.gd
    assets/textures/shadow_blob.png
  </files>
  <action>
Create the PlayerCharacter scene structure following RESEARCH.md architecture:

**Scene hierarchy:**
```
PlayerCharacter (CharacterBody3D)
├── Sprite (Sprite3D)
├── ShadowCaster (ShapeCast3D)
│   └── BlobShadow (Decal)
└── CollisionShape (CollisionShape3D)
    └── CapsuleShape3D
```

**Sprite3D configuration (CRITICAL - these settings ensure HD-2D look):**
- `billboard = BaseMaterial3D.BILLBOARD_FIXED_Y` (value 2 in .tscn)
- `texture_filter = BaseMaterial3D.TEXTURE_FILTER_NEAREST` (value 0)
- `alpha_cut = SpriteBase3D.ALPHA_CUT_OPAQUE_PREPASS` (value 2 - proper depth sorting with 3D)
- `shaded = true` (scene lights affect sprite)
- `double_sided = true` (visible from both sides)
- `pixel_size = 0.01` (adjust based on sprite resolution - 64px sprite = ~0.64 world units)
- `modulate = Color(0.95, 0.95, 0.95, 1.0)` (slightly muted for subtle lighting)
- `offset = Vector2(0, height/2)` where height = sprite pixel height (origin at feet)

**Blob shadow setup:**
1. Create a simple 64x64 white circular gradient PNG for shadow texture at `assets/textures/shadow_blob.png`
   - White center fading to transparent edges (radial gradient)
   - This gets tinted dark by the Decal

2. ShapeCast3D configuration:
   - `target_position = Vector3(0, -5, 0)` (cast downward to detect floor)
   - `collision_mask = 1` (floor should be on layer 1)

3. Decal configuration:
   - `size = Vector3(0.5, 1.0, 0.5)` (elliptical shadow)
   - `modulate = Color(0, 0, 0, 0.4)` (semi-transparent black)
   - `cull_mask = 1` (only project on floor, not on character)
   - `upper_fade = 0.0`, `lower_fade = 0.1`

**CollisionShape3D (prep for Controls phase):**
- CapsuleShape3D with radius ~0.2, height ~0.8 (adjust to sprite proportions)
- This enables CharacterBody3D movement in Phase 3

**Script (player_character.gd):**
```gdscript
extends CharacterBody3D

@onready var shadow_caster: ShapeCast3D = $ShadowCaster
@onready var blob_shadow: Decal = $ShadowCaster/BlobShadow

func _physics_process(_delta: float) -> void:
    _update_shadow()

func _update_shadow() -> void:
    if shadow_caster.get_collision_count() > 0:
        var hit_point = shadow_caster.get_collision_point(0)
        blob_shadow.global_position = hit_point + Vector3(0, 0.01, 0)
        blob_shadow.visible = true
    else:
        blob_shadow.visible = false
```

**Important notes:**
- Do NOT use pixel_size smaller than 0.005 (sprite becomes too small)
- The offset.y should be half the sprite's pixel height to place feet at origin
- Leave texture property empty for now - user will provide sprite asset
  </action>
  <verify>
Run in Godot editor:
1. Open scenes/character/player_character.tscn
2. Verify scene tree has: CharacterBody3D > Sprite3D, ShapeCast3D > Decal, CollisionShape3D
3. Verify Sprite3D billboard property is set to Fixed Y (value 2)
4. Verify Sprite3D texture_filter is Nearest (value 0)
5. Verify assets/textures/shadow_blob.png exists
  </verify>
  <done>
PlayerCharacter scene exists with properly configured Sprite3D (Y-axis billboard, nearest filtering), blob shadow system (ShapeCast3D + Decal), and collision shape.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate PlayerCharacter into interior scene</name>
  <files>
    scenes/interior/interior_scene.tscn
  </files>
  <action>
Add PlayerCharacter instance to the interior scene:

1. Instance `scenes/character/player_character.tscn` as child of InteriorScene root
2. Position at room center: `transform.origin = Vector3(0, 0, 0)`
   - This places character in the open floor area (floor tiles span -1 to 1 on X and Z)
   - The character's feet will be at Y=0 (floor level)

3. Add to Assets node or directly under root (alongside Camera3D, Lighting, etc.)
   - Recommended: Add under root as "Player" node for easy access

4. Ensure floor tiles are on collision layer 1:
   - The floor models (floorFull.glb instances) need StaticBody3D with collision
   - If floor lacks collision, add a simple floor collider plane at Y=0

**Floor collision note:**
The current scene uses glb floor tiles. Check if they have built-in collision:
- If yes: ShapeCast3D will detect them
- If no: Add a StaticBody3D with BoxShape3D at Y=0 spanning the floor area

The blob shadow needs something to project onto. If floor has no collider, add:
```
FloorCollider (StaticBody3D)
└── CollisionShape3D
    └── BoxShape3D (size: 4, 0.1, 4, position: 0, -0.05, 0)
```
  </action>
  <verify>
Run in Godot editor:
1. Open scenes/interior/interior_scene.tscn
2. Verify Player node exists as child of InteriorScene
3. Verify Player position is approximately (0, 0, 0)
4. Run the scene - camera should show the room with character placeholder visible
  </verify>
  <done>
PlayerCharacter is instanced in interior scene at room center, positioned with feet on floor level.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify character visual integration</name>
  <what-built>
PlayerCharacter scene with Y-axis billboard Sprite3D, blob shadow system, and collision shape. Character is positioned at room center in the interior scene.
  </what-built>
  <how-to-verify>
**Step 1: Provide character sprite**
Place a pixel-art character sprite PNG in the project (e.g., `assets/textures/character.png`).
- Recommended: 32x64 or 64x128 pixel character facing forward
- Transparent background
- If you don't have one, use any pixel art character sprite for testing

**Step 2: Assign texture**
1. Open `scenes/character/player_character.tscn` in Godot editor
2. Select the Sprite node
3. In Inspector, drag your PNG to the Texture property
4. Adjust `Pixel Size` if character appears too large/small (try 0.008-0.015)
5. Adjust `Offset Y` to half the sprite's pixel height (e.g., 32 for a 64px tall sprite)

**Step 3: Run and verify**
1. Run the scene (F5 or click Play)
2. Verify these visual requirements:
   - [ ] Character sprite is visible in the room
   - [ ] Character stays upright (doesn't tilt with camera)
   - [ ] Character faces the camera (billboard rotates horizontally)
   - [ ] Pixels are crisp (no blurring or interpolation)
   - [ ] Blob shadow is visible on floor beneath character
   - [ ] Character scale looks appropriate relative to furniture (~95% realistic)
   - [ ] Character feet appear to touch the floor

**Step 4: Orbit camera test (if controls exist)**
If you can rotate the camera view in editor, verify the billboard follows.
  </how-to-verify>
  <resume-signal>
Type "approved" if character looks correct, or describe any visual issues to fix:
- Scale problems (too big/small)
- Billboard not working (sprite tilts or doesn't face camera)
- Shadow issues (missing, wrong position, too dark/light)
- Filtering issues (blurry pixels)
- Positioning issues (floating, clipping into floor)
  </resume-signal>
</task>

</tasks>

<verification>
Phase 2 verification checklist:
1. PlayerCharacter scene file exists at scenes/character/player_character.tscn
2. Sprite3D has billboard=2 (FIXED_Y), texture_filter=0 (NEAREST)
3. Blob shadow Decal projects onto floor
4. Character instanced in interior_scene.tscn
5. User visually approves the HD-2D character integration
</verification>

<success_criteria>
- Player character sprite visible in the 3D interior scene
- Sprite billboards horizontally to face camera (Y-axis only, stays upright)
- Sprite displays with crisp nearest-neighbor filtering (no blur)
- Sprite integrates visually with 3D environment (correct scale, feet on floor)
- Blob shadow grounds the character in the scene
- Requirements SPRT-01 and SPRT-02 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-character/02-01-SUMMARY.md`
</output>

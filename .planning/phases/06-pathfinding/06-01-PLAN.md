---
phase: 06-pathfinding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scenes/interior/interior_scene.tscn
  - scenes/character/player_character.gd
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Clicking on far side of furniture causes character to path around it"
    - "Character cannot walk through solid furniture"
    - "Navigation responds immediately to clicks (no perceptible delay)"
    - "Movement retains eased acceleration/deceleration feel"
  artifacts:
    - path: "scenes/character/player_character.gd"
      provides: "NavigationAgent3D-based pathfinding"
      contains: "navigation_agent.get_next_path_position"
    - path: "scenes/interior/interior_scene.tscn"
      provides: "NavMesh that sees furniture geometry"
      contains: "geometry_parsed_geometry_type = 0"
  key_links:
    - from: "player_character.gd _handle_click"
      to: "navigation_agent.target_position"
      via: "set target on NavigationAgent3D"
      pattern: "navigation_agent\\.target_position\\s*="
    - from: "player_character.gd _physics_process"
      to: "navigation_agent.get_next_path_position()"
      via: "query next waypoint each frame"
      pattern: "get_next_path_position\\(\\)"
    - from: "NavigationMesh geometry_type"
      to: "furniture GLB meshes"
      via: "MESH_INSTANCES parsing"
      pattern: "geometry_parsed_geometry_type = 0"
---

<objective>
Restore NavigationAgent3D pathfinding so character paths around furniture instead of walking through it.

Purpose: The audit identified that pathfinding was removed due to async navmesh timing issues. The infrastructure exists (NavigationAgent3D on player, NavigationRegion3D in scene) but is orphaned. This plan wires everything together with the correct timing pattern and navmesh configuration.

Output: Working pathfinding where clicking across furniture causes the character to route around obstacles while maintaining the eased motion feel.
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-pathfinding/06-RESEARCH.md

# Current implementation (to be modified)
@scenes/character/player_character.gd
@scenes/interior/interior_scene.tscn
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix NavMesh to parse mesh instances instead of static colliders</name>
  <files>scenes/interior/interior_scene.tscn</files>
  <action>
In the NavigationMesh sub_resource in interior_scene.tscn, change:

```
geometry_parsed_geometry_type = 1
```

To:

```
geometry_parsed_geometry_type = 0
```

This changes the navmesh from STATIC_COLLIDERS (type 1) to MESH_INSTANCES (type 0). The GLB furniture models don't have collision shapes, so the navmesh currently sees a flat walkable floor with no obstacles. MESH_INSTANCES parses the actual mesh geometry, creating holes around furniture.

Do NOT change any other navmesh parameters (cell_size, agent_radius, etc. are already correct from 03-01).
  </action>
  <verify>
1. Open interior_scene.tscn in text editor and confirm geometry_parsed_geometry_type = 0
2. In Godot editor: Select NavigationRegion3D, click "Bake NavMesh" in toolbar
3. Verify navmesh preview shows holes/cutouts around furniture (not a flat rectangle)
  </verify>
  <done>NavMesh configuration updated to parse mesh instances. Furniture creates obstacles in the baked navmesh.</done>
</task>

<task type="auto">
  <name>Task 2: Rewire player controller to use NavigationAgent3D with deferred setup</name>
  <files>scenes/character/player_character.gd</files>
  <action>
Rewrite player_character.gd to use NavigationAgent3D instead of direct movement. Key changes:

1. **Add navigation_agent reference and ready flag:**
```gdscript
@onready var navigation_agent: NavigationAgent3D = $NavigationAgent3D
var _navigation_ready: bool = false
```

2. **Deferred navigation setup (CRITICAL for timing):**
```gdscript
func _ready() -> void:
    _setup_navigation.call_deferred()

func _setup_navigation() -> void:
    await get_tree().physics_frame
    _navigation_ready = true
```

3. **Guard click handling until navigation ready:**
```gdscript
func _handle_click(screen_pos: Vector2) -> void:
    if not _navigation_ready:
        return  # Ignore clicks until navigation is ready
    # ... rest of raycast logic unchanged ...
```

4. **Set target on NavigationAgent3D instead of storing directly:**
```gdscript
func _set_movement_target(target_pos: Vector3) -> void:
    navigation_agent.target_position = target_pos
    is_moving = true
    # Remove: target_position = target_pos (use agent's target)
```

5. **Query NavigationAgent3D for next waypoint in movement loop:**
```gdscript
func _update_movement(delta: float) -> void:
    if not _navigation_ready or not is_moving:
        return

    if navigation_agent.is_navigation_finished():
        is_moving = false
        current_speed = 0.0
        velocity = Vector3.ZERO
        return

    # Get next waypoint from NavigationAgent3D (this is the path-following)
    var next_pos = navigation_agent.get_next_path_position()
    var to_target = next_pos - global_position
    to_target.y = 0
    var direction = to_target.normalized()

    # Use distance to FINAL target for deceleration (not next waypoint)
    var distance_to_target = global_position.distance_to(navigation_agent.target_position)
    # ... rest of eased motion logic unchanged ...
```

6. **Remove the local target_position variable** - use navigation_agent.target_position instead.

Keep these UNCHANGED:
- MAX_SPEED, ACCELERATION, DECELERATION, ARRIVAL_THRESHOLD constants
- shadow_caster and blob_shadow references
- _update_shadow() function
- Eased motion math (decel_distance calculation, speed ramping)

The complete rewrite is provided in 06-RESEARCH.md "Complete Navigation Setup" section if needed as reference.
  </action>
  <verify>
1. Run the scene in Godot
2. Click on the floor near the character - character should move to click position
3. Click on the far side of furniture (e.g., behind the sofa) - character should path AROUND the furniture, not through it
4. Verify movement still has smooth acceleration at start and deceleration near destination
5. Click rapidly to different positions - should redirect immediately without delay
  </verify>
  <done>Player controller uses NavigationAgent3D for pathfinding. Character paths around furniture with eased motion preserved.</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Navmesh visual check:** In Godot editor, NavigationRegion3D debug view shows walkable area with furniture cutouts
2. **Pathfinding functional:** Clicking behind furniture causes character to walk around it
3. **No walk-through:** Character cannot clip through furniture when moving
4. **Motion feel preserved:** Movement has same smooth start/stop as before
5. **No first-frame issues:** First click after scene load works correctly (deferred setup working)
</verification>

<success_criteria>
- NavigationMesh uses MESH_INSTANCES (geometry_parsed_geometry_type = 0)
- player_character.gd queries NavigationAgent3D.get_next_path_position()
- Character paths around furniture instead of through it
- Eased motion (accel/decel) is preserved
- Navigation works on first click (no timing issues)
</success_criteria>

<output>
After completion, create `.planning/phases/06-pathfinding/06-01-SUMMARY.md`
</output>
